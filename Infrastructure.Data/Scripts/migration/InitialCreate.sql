IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[SystemSetting] (
        [Id] uniqueidentifier NOT NULL,
        [Key] nvarchar(100) NOT NULL,
        [Value] nvarchar(200) NULL,
        [Flags] int NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_SystemSetting] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[TodoItem] (
        [Id] uniqueidentifier NOT NULL,
        [Name] nvarchar(100) NOT NULL,
        [Status] int NOT NULL,
        [SecureRandom] varbinary(200) NULL,
        [SecureDeterministic] varbinary(200) NULL,
        [IsDeleted] bit NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_SystemSetting_Key] ON [todo].[SystemSetting] ([Key]);
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
    BEGIN
    CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
    WITH (
        KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
        KEY_PATH = N'[AKV-CMK-URL]',
        ENCLAVE_COMPUTATIONS (SIGNATURE = 0x9D4DB87C84175AA3CB86521EFD6C968EE0FA35F283236A068B216B6736D7DA5A6C2D86A64031EE2EF9EAECE1D69D9CEBB3E8F96D24F7E4748E24C5FFD8390D4C7271B74C97592650CAFC5BBBDBAB5C10BEF41909D642B00C44FDB74A3A335F0553F85A7ABB1A2A59B3588B6FB03ED8CFDED8481D75A918D5C32E396B19B3280CA11D0571488FDFF246477DAC2322F496D881EA3C198FF32BC2157DC82AA55013D2BA79052F626B0B015AB892EFD5657C3B3861B212C9566BBAD2C4E38DFA68C9DEA93554481FBC07B78FF11C7AB46E5FB6662DEE619E7DF9285F9ADF738A0B292B6B62023F41029B4F5D485D5FFF9EA9A7031141DC3598661E00DDFD531C981E)
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
    END

END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
    BEGIN
    CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
    WITH VALUES (
        COLUMN_MASTER_KEY = [CMK_WITH_AKV],
        ALGORITHM = 'RSA_OAEP', 
        ENCRYPTED_VALUE = 0x01A8000001680074007400700073003A002F002F00650066002D006B0076002D006400650076002D00310061002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006D006B002D0031002F0037003100300036003300620064003600370037003400640034003800380031003800370035006200660035003500340066006400380032003200370066006100761229D96302872DE3D68B070AC1080C982AF732B51D94E334D660F5B9B2463DE26E1F0CB43F7ACF763B3A70EC67AC2058A3AFB612BF0CE8E8144F99C562924B95AD7E0C377F87CD4FCD8C7349B58CE27405E642405923E0B063684B8122E7C4F24CDBEB31C42E305660BD89EFD3CCBAC029CB932B73E220894A22E200D24234A195525203D4F7BECDFF950FD7D71D929A20E98C970B89D74B9656A015A52A1D96E210D6215C2E1563EAEFC3418B13C9B32DF91A349B84744CD42AFD4453F133F4D54F45A6E1AEDD6628B7CF7736BAC3083AEC581409FD7842E88E27E3EF8E2390056B1C6712E9CB50931AC151962D5F41AE7C78C48B5D160515D5892AA1A002ACCF95F54CF8B8424973672904F41D7F350236FB7FCCA063D24B8E7CC05F0AA16BA45B357BBC922E89502583BF4F454C458814FC236E04EA7DCBC0E3258221D3972B729C365F66B3E9EC0D9C7D593CC07D005F7CBA99ADCECDE831BA667D28D3F74959443E9936C0B2505FCA465843FB6DFBBD9C450A9474F36F55A58C02E22B6D311F82B13BBEFF1B7387DEF141CDB01EA5836B328B3ECA3EDB8AD641B687EB786969E46DB016F2906E6747DE5235D37ACFA70BBE60BE8248C2EA69EB10454C482A41A8A0604A6173A7F84D6C087E81383110AC08B94C530EA6D8CD984C0575116B8A8761389029BDA567E25972E1117013B17B7F0AE76025E441E9BA972453
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
    END
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureDeterministic] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = DETERMINISTIC, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureRandom] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = RANDOMIZED, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240411195536_InitialCreate'
)
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20240411195536_InitialCreate', N'8.0.3');
END;
GO

COMMIT;
GO

