IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[SystemSetting] (
        [Id] uniqueidentifier NOT NULL,
        [Key] nvarchar(100) NOT NULL,
        [Value] nvarchar(200) NULL,
        [Flags] int NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_SystemSetting] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[TodoItem] (
        [Id] uniqueidentifier NOT NULL,
        [Name] nvarchar(100) NOT NULL,
        [Status] int NOT NULL,
        [SecureRandom] varbinary(100) NULL,
        [SecureDeterministic] varbinary(100) NULL,
        [IsDeleted] bit NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_SystemSetting_Key] ON [todo].[SystemSetting] ([Key]);
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
    BEGIN
    CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
    WITH (
        KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
        KEY_PATH = N'[AKV-Url-CMK]',
        ENCLAVE_COMPUTATIONS (SIGNATURE = 0x78416CBFC9201E431B920DFB9E90C3918DE1AAD3B71FE1E4149D04B3A43FB6E33FA9999D4E37FB14A9BE299B0351D42F13B21C0E683765AC70B4D23D3CE93536E3AC47F9D6027E07D023270C822D06E70A2833E979F8B16735386B769CEC24366BDCA4D2A5EE17266A31CC2130EAA9CA680471919C094C4C8213151168ACEA60BABB89428A18AA6F8CF44983B58B23A12911289C98D0C023651A41E6DE2E9D59779A118277B6F33E52D39BB23E9E6A6228113BF1F3A804688BF7587C465F6C0CC99598C1961F5255BCFF1CBC0C9E6A259BB563CA4E77F8D39A0D37C916DC8E814157FAD5C3864519A31E09DFF01271C7696C16CD36EAE82898417CA9B2BCC249)
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
    END

END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
    BEGIN
    CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
    WITH VALUES (
        COLUMN_MASTER_KEY = [CMK_WITH_AKV],
        ALGORITHM = 'RSA_OAEP', 
        ENCRYPTED_VALUE = 0x017E000001680074007400700073003A002F002F006400650076002D006B0076002D00610034002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006F006C006D00610073006B00650072006B00650079002D00640065006600610075006C00740037E4C4EAA8425F17A76D605DCC6E3EB91A1D635745F3F66C1121D2FB86F65F88BC140AD804933C161FD61DA2F57AE69AA97D54A2BBA38772111BF937221848F502DCE88625D00FB81315BBACC514E92627011C53F7BCC05E82E12FE51CB8E6F64A51587D26CBD2932A98C63EDE28D09A8DF1ECD5F2DE5F2AECAADBF782B8620E9742A31D3860A45FDE1556386235696F0849D68ADB64C5E203150434487DCCCA0A381ED9031F2DAD42B9F47759E686B308766B2240F488ACF5CE0DD6A4A1973C38718FA5FABC6B45549C27368053BBB8BE5D35233DB0211C7E6CFD0D1D34EC0B4CEB1F00406E51C88979A77185B8176055DCE3183E75781AC0DF123AFEB62FE8B317878B463F8A6B39A67F83F92D7C0A756069682B5BF818E796DDBB045E7FEB5936DD7BF174F0F7F34027FE64FA70E11DFC41BC1DF0DDF159778459FC1DFAE7C157CA58D3508A23E09754651F6452BDE044F4189475090D7EBEB4692BC66B69B538E76D967CB81F57AAB66F8C7877029326B5029866D46611F1276726DDBB7C5C3DFCAF2620B03EED93F61E91CB15ABE9AB20DFBE2CB60D8935E2A49D5504034820780008162D6D87B7F7380BB3B680E1436EBC802A8412AC6FAE158E85A24EF811399FAF7930D6C3BA7FB5BA78BE151DDB0443467C113C8C7109FCA4830B1F8979319F9933FF133E2A6C4FA4B854CC8A5609EB6DBE21F94A0B6F3B69209652
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
    END
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureDeterministic] varbinary(100) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = DETERMINISTIC, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureRandom] varbinary(100) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = RANDOMIZED, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;
GO

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20240328232558_InitialCreate'
)
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20240328232558_InitialCreate', N'8.0.3');
END;
GO

COMMIT;
GO

