IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
GO

CREATE TABLE [todo].[SystemSetting] (
    [Id] uniqueidentifier NOT NULL,
    [Key] nvarchar(100) NOT NULL,
    [Value] nvarchar(200) NULL,
    [Flags] int NOT NULL,
    [CreatedDate] datetime2(0) NOT NULL,
    [CreatedBy] nvarchar(100) NOT NULL,
    [UpdatedDate] datetime2(0) NOT NULL,
    [UpdatedBy] nvarchar(100) NULL,
    [RowVersion] rowversion NULL,
    CONSTRAINT [PK_SystemSetting] PRIMARY KEY NONCLUSTERED ([Id])
);
GO

CREATE TABLE [todo].[TodoItem] (
    [Id] uniqueidentifier NOT NULL,
    [Name] nvarchar(100) NOT NULL,
    [Status] int NOT NULL,
    [SecureRandom] nvarchar(100) NULL,
    [SecureDeterministic] nvarchar(100) NULL,
    [IsDeleted] bit NOT NULL,
    [CreatedDate] datetime2(0) NOT NULL,
    [CreatedBy] nvarchar(100) NOT NULL,
    [UpdatedDate] datetime2(0) NOT NULL,
    [UpdatedBy] nvarchar(100) NULL,
    [RowVersion] rowversion NULL,
    CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
);
GO

CREATE UNIQUE CLUSTERED INDEX [IX_SystemSetting_Key] ON [todo].[SystemSetting] ([Key]);
GO

CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
GO

IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
BEGIN
CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
WITH (
    KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
    KEY_PATH = N'https://ef-kv-dev-1.vault.azure.net/keys/sql-cmk-1/4c902abcbcda48b2aee580e0b5c55f2b',
    ENCLAVE_COMPUTATIONS (SIGNATURE = 0x6287DC30F270054FE2811D0156E1657526297BE58AEB7E2EA758655BFA408C802F0F3506D6FF4F2FFC9C87D94B5302D3BC976CBBC323ED2D8AAFA0483C493AEDCB0178DB242FF0BF2E90DF5EBCE34B841F4B10F0EA66940C186B03FFED75D4887DB630F05D675CFE016F617A475241A5013A2686C7431812060FFD03EF88D8B93D9195AB8D497E52D268BE68C1BD513907BE6C07FF94A61BB8EA64EFD172ACEA662253DB448F6D816B1B04C5A156B503CDA57AE5123A72318EBAB5E9A51063E2925868A41C05DD6AFA0B08EC243E5E04BEAE2FD68C0CA6A29D4590D78A5ADC5F7FFA0B41F31255BA4ED90C15EB2077A037E10E375EC313ED45AEB291FA11326A)
);
END
ELSE
BEGIN
    SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
END
GO

IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
BEGIN
CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
WITH VALUES (
    COLUMN_MASTER_KEY = [CMK_WITH_AKV],
    ALGORITHM = 'RSA_OAEP', 
    ENCRYPTED_VALUE = 0x01A6000001680074007400700073003A002F002F00650066002D006B0076002D006400650076002D0031002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006D006B002D0031002F003400630039003000320061006200630062006300640061003400380062003200610065006500350038003000650030006200350063003500350066003200620095A987BF1ACA53F8CAAE1FBDC205EE349F408041F5837B539F93261EE83FF6102017CECF315C6EAA23082D98A1D168B54BF8D27CB79F521845D075BEFA63335BD49AF06DB0C87F3DD403834B3A6CBB18CDE8280A02F31FDF3F928CF692024B80A01C88607A2748A675471548A86410C58461666AE2B676ACB9BE74DEF89EDE410293145A453512D2BF74218BB4FC660644D69A6A378245FC077A709D9366F0B40F7ADCDC06D7A3C3D649ED3D62C28C97F246E7420A07D77A01650C35F585A4E7DEA64259365D0386DA0910AE235E3F5774674313375EE8A83F0C5FC6D412D2683160687336366D1C0990932843CF36083772B97A72B7F619F9F908A3FF4E240C6A854EB0B48369FE10F34EDCE2194127A3D0D0AD97AED4CD47511F2B104783A582C59F794E54A252383BA25DBC435BA844CB9EAB21492CD5D5D1C71E10F55F503B45655D58DD7F5BAD5567B4F7A91F10087304E66ACCD1D9229A8DA8699AFB26006A6F8C0DCE228337F09C54379396D216D21B183976B3B0E5C416B97869E56543F607AB33A1A557810BEAF9D6A2928DCC77EFDD70195DF2F7FCD5899C3CBB7E2FCBC74A9A01A0399F89FA75EDD6A4450CC05AEFFF0260F7BD2EF2FB5CF90F18A295C92106181F8DAF482A1F31D941AB498D01E4E5E12727F73AFCDB55433BA6BFC0044BF60F6F0547A9C03DB20B43022AA6E6B258E20E0EC46246AA55E35742
);
END
ELSE
BEGIN
    SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
END
GO

ALTER TABLE [todo].[TodoItem]
                                ALTER COLUMN [SecureDeterministic] nvarchar(100) 
                                COLLATE Latin1_General_BIN2 ENCRYPTED WITH(
                                        ENCRYPTION_TYPE = DETERMINISTIC, 
                                        ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                        COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
GO

ALTER TABLE [todo].[TodoItem]
                                ALTER COLUMN [SecureRandom] nvarchar(100) 
                                COLLATE Latin1_General_BIN2 ENCRYPTED WITH(
                                        ENCRYPTION_TYPE = RANDOMIZED, 
                                        ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                        COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230829152511_InitialCreate', N'8.0.0-preview.7.23375.4');
GO

COMMIT;
GO

