IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[SystemSetting] (
        [Id] uniqueidentifier NOT NULL,
        [Key] nvarchar(100) NOT NULL,
        [Value] nvarchar(200) NULL,
        [Flags] int NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_SystemSetting] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[TodoItem] (
        [Id] uniqueidentifier NOT NULL,
        [Name] nvarchar(100) NOT NULL,
        [Status] int NOT NULL,
        [SecureRandom] varbinary(200) NULL,
        [SecureDeterministic] varbinary(200) NULL,
        [IsDeleted] bit NOT NULL,
        [RowVersion] rowversion NULL,
        CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_SystemSetting_Key] ON [todo].[SystemSetting] ([Key]);
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
    BEGIN
    CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
    WITH (
        KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
        KEY_PATH = N'https://ef-kv-dev-1a.vault.azure.net/keys/SQL-CMK-1',
        ENCLAVE_COMPUTATIONS (SIGNATURE = 0x618BC716B6C42E76978EBFF0A6A31E98585DDE2E3C0576DAC060C00CF782E4EFF00437FAEC7DB580BD19BD50419C3DD6E6A9FD5F88A63C58E813A619066CEC490651A2C6D2470126E46D5CCEA4E4A5E3D842DAB616D7464606FE61138D60B68C8CCE027717FBEF73DF93107CB0739A31A3D965FB1483FF22BA82108BFB318C8DD62897783AA88313AC40B2B515B26B1FDAD2F5AD35FBEA994D41C123311F507F7993504F88E07229A86E4A886A4714F61B572289A69207793556D068CEC4E9F5947AEA9DE458EBE0CD7DD5F54A88DBD30759D20D10DBC2FC5ADF6AB4B4B10EC133069F26DFFDD3FF134ACB12A0A0A52B1ACEA7E94001D3A7701C1C50A66DD984)
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
    END

END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
    BEGIN
    CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
    WITH VALUES (
        COLUMN_MASTER_KEY = [CMK_WITH_AKV],
        ALGORITHM = 'RSA_OAEP', 
        ENCRYPTED_VALUE = 0x0166000001680074007400700073003A002F002F00650066002D006B0076002D006400650076002D00310061002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006D006B002D00310019E55964606B604CFFAC65238CDF0AE00EEEB1D207F5708B89E63AD89EB282A67F368A7B87FEC9F8FEC8FCCC47F9B7928F0CA9DEEB62EC3E51F0F45DF81EA35B022479549350692B477E7D1AFCCD6D83E5D16B7E33667C271E0065AEC7B962C193B0FAA15AF4D1AF14280C73E5CAE96F12FFD4A20BE614587A4A2268BD3381B83ABF2287A8BFD29B672909590C8E2C6AF009CAD7DE4CB1B838CD4833E08B728A88CEF56C25E84D85F4C79D4F5ADDC505EFD78FFCFAC52E4B3D10E3C758A0CA8FC5BFA4A167A9D7CCAED816FE22C764A979D477FBF64AC05FE3712E8F60ACFB781528A965D8CC5CD68E04B784ED7C534D5BA27BAD86B70E4AC1FD5D1EDC03923DC1919B94B46C60E816833E0A2DF0CD608789A8FFCAE5F8A5646DDA9C716AEAEDA1DC6619D6CC42876BB67CAA529480CE1CA7ABF672246BA198DD153A0AF0843C79F25E2FDDBC5339C5C599C09CDE62A7F6AD130B09139F3E7A24D545A4DFAA9D34F5B9B24BFF5B7EAD447C97A7B094B055D9647A118C48501752B9DD60A93FB174D1D7B6EF478417D06D7012BFDDA698F9D353AEC11E5C4C81A47EACFF90862D3C12E3367F1F78AEEF1A8E5A7B5AE5EF48172E6ABAD2322E5AD28F1CDAC2BD260E65190A35E81B10FA552182C87846C5D863E16E1210BE12E3A3E17F7E96AA4D3EFC639012F93EA4CBBFD3E5A902234DC51C8A7456F31F3FB6AC04AA49145018
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
    END
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureDeterministic] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = DETERMINISTIC, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureRandom] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = RANDOMIZED, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20241202164906_InitialCreate', N'9.0.0');
END;

COMMIT;
GO

