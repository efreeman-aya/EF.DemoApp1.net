IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
GO

CREATE TABLE [todo].[TodoItem] (
    [Id] uniqueidentifier NOT NULL,
    [Name] nvarchar(100) NOT NULL,
    [Status] int NOT NULL,
    [SecureRandom] nvarchar(100) NULL,
    [SecureDeterministic] nvarchar(100) NULL,
    [CreatedDate] datetime2(0) NOT NULL,
    [CreatedBy] nvarchar(100) NOT NULL,
    [UpdatedDate] datetime2(0) NOT NULL,
    [UpdatedBy] nvarchar(100) NULL,
    [RowVersion] rowversion NOT NULL,
    CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
);
GO

CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
GO


IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
BEGIN
CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
WITH (
    KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
    KEY_PATH = N'https://dev-kv-a4.vault.azure.net/keys/SQL-ColMaskerKey-Default/3706efcbd65d4ed599d62a1dfa3e94b6',
    ENCLAVE_COMPUTATIONS (SIGNATURE = 0x3D580D75A9CD52EE93B5652E8840EAA261CA07505E1107765D14789F5071AB7E08172AF2839E55D40518BB36E37262F59F335CD758500AEA5DE9A6C7F1B5C9929E5EC26B34A6DEB9F72DD9DFDE667B3DF761BD1EB45E353D897A11BDCCFAD7143F1D506AFD702C1AF18000ABB908ACB6206CF60F89032F119CFF277938DB3105428EED5F49BA2A4E2E95C7AE1B1495EDF39BDC7BD22BB119BD1A0BF2E388FF2126CEADF1C59B8F9767121042C75E311C105D2C3DAF41E34409883BFE1417056F4BE4970E96F4FDC78A8B61811930EDF4E89FF62108C6B32EDD87F0FACCC4EE42E8B32C9130FD454B8EE57A830E19B67F0881EC8AA38CF71BD67F3B962A915008)
);
END
ELSE
BEGIN
    SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
END

GO


IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
BEGIN
CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
WITH VALUES (
    COLUMN_MASTER_KEY = [CMK_WITH_AKV],
    ALGORITHM = 'RSA_OAEP', 
    ENCRYPTED_VALUE = 0x01C0000001680074007400700073003A002F002F006400650076002D006B0076002D00610034002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006F006C006D00610073006B00650072006B00650079002D00640065006600610075006C0074002F00330037003000360065006600630062006400360035006400340065006400350039003900640036003200610031006400660061003300650039003400620036007C4BE99AA4A0223F88257C719685686A7FF075D75693268DC0CD4CA544338A5C7FA4E812093BE376979FA0F6482250FABA1DED56CF4E787A3D989FC83750E466BAFE437005D74F51C2A77A18FECF542706D13625942C1330A529B72B7991AF9FD9FCAD4F62D18C67BBD1D32AB38E0EF3E5114FA2E9ECD3433CBE631F218236374A3C97C981F8096A75EBD261F2A4FF566177854A63411790B7CD7FF342D5E944731983AE45943FE8791DA1D70233985EF1D131C487A957352FB7924FDF837AE11D6EBDBBFB67921096213B2E5CE12D7AB6A631352AD868D82B8A1E9068118B67B8BE6F2636667F96926713ACBFB3A438852A1AE06080D07103F4A8E981B9C422802B86AFBE3EC841BD79D9B3B1C2A35B11CBC897EC856533951270AF43913E9CA02FC7DEA8210C9068BA396EC28B9CAD93951D9BB3727643FD2009460D5D3F8BA1F9AAD79BCFFA87AE833C0D9A770A051ED07EB518A849537FD9BEF33E9AEA612F3F3C1E654E0D9157A8346234F25CD401CAB7946022BB295FACA16FA136D47C2558103BDEC2AF4CE6D53FDA2B4E506E8D9BFE171736BD71BBE3065760A766967F1AF12FADF28EB9D0E3DA4DA11FF4FF1350C1F0E5178F9920AEB549E0107C6D54C65DE528C00CD41A39596B7F8520A04694F2117B89DEFC6A1D50D63CCF234358F005F957A4E756383ECCE578970251F2D4DE48F8EC30A398698635E645EC9B
);
END
ELSE
BEGIN
    SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
END
GO

ALTER TABLE [todo].[TodoItem]
                                ALTER COLUMN [SecureDeterministic] nvarchar(100) 
                                COLLATE Latin1_General_BIN2 ENCRYPTED WITH(
                                        ENCRYPTION_TYPE = DETERMINISTIC, 
                                        ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                        COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
GO

ALTER TABLE [todo].[TodoItem]
                                ALTER COLUMN [SecureRandom] nvarchar(100) 
                                COLLATE Latin1_General_BIN2 ENCRYPTED WITH(
                                        ENCRYPTION_TYPE = RANDOMIZED, 
                                        ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                        COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20230810175750_InitialCreate', N'7.0.10');
GO

COMMIT;
GO

