IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    IF SCHEMA_ID(N'todo') IS NULL EXEC(N'CREATE SCHEMA [todo];');
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[SystemSetting] (
        [Id] uniqueidentifier NOT NULL,
        [Key] nvarchar(100) NOT NULL,
        [Value] nvarchar(200) NULL,
        [Flags] int NOT NULL,
        [RowVersion] rowversion NULL,
        [CreatedDate] datetime2(0) NOT NULL,
        [CreatedBy] nvarchar(100) NOT NULL,
        [UpdatedDate] datetime2(0) NULL,
        [UpdatedBy] nvarchar(100) NULL,
        CONSTRAINT [PK_SystemSetting] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE TABLE [todo].[TodoItem] (
        [Id] uniqueidentifier NOT NULL,
        [Name] nvarchar(100) NOT NULL,
        [Status] int NOT NULL,
        [SecureRandom] varbinary(200) NULL,
        [SecureDeterministic] varbinary(200) NULL,
        [IsDeleted] bit NOT NULL,
        [RowVersion] rowversion NULL,
        CONSTRAINT [PK_TodoItem] PRIMARY KEY NONCLUSTERED ([Id])
    );
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_SystemSetting_Key] ON [todo].[SystemSetting] ([Key]);
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    CREATE UNIQUE CLUSTERED INDEX [IX_TodoItem_Name] ON [todo].[TodoItem] ([Name]);
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_master_keys WHERE name = 'CMK_WITH_AKV')
    BEGIN
    CREATE COLUMN MASTER KEY [CMK_WITH_AKV]
    WITH (
        KEY_STORE_PROVIDER_NAME = N'AZURE_KEY_VAULT',
        KEY_PATH = N'https://ef-kv-dev-1.vault.azure.net/keys/sql-cmk-1/4c902abcbcda48b2aee580e0b5c55f2b',
        ENCLAVE_COMPUTATIONS (SIGNATURE = 0x6287DC30F270054FE2811D0156E1657526297BE58AEB7E2EA758655BFA408C802F0F3506D6FF4F2FFC9C87D94B5302D3BC976CBBC323ED2D8AAFA0483C493AEDCB0178DB242FF0BF2E90DF5EBCE34B841F4B10F0EA66940C186B03FFED75D4887DB630F05D675CFE016F617A475241A5013A2686C7431812060FFD03EF88D8B93D9195AB8D497E52D268BE68C1BD513907BE6C07FF94A61BB8EA64EFD172ACEA662253DB448F6D816B1B04C5A156B503CDA57AE5123A72318EBAB5E9A51063E2925868A41C05DD6AFA0B08EC243E5E04BEAE2FD68C0CA6A29D4590D78A5ADC5F7FFA0B41F31255BA4ED90C15EB2077A037E10E375EC313ED45AEB291FA11326A)
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN MASTER KEY [CMK_WITH_AKV] exists.'
    END

END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN

    IF NOT EXISTS (SELECT * FROM sys.column_encryption_keys WHERE name = 'CEK_WITH_AKV')
    BEGIN
    CREATE COLUMN ENCRYPTION KEY [CEK_WITH_AKV] 
    WITH VALUES (
        COLUMN_MASTER_KEY = [CMK_WITH_AKV],
        ALGORITHM = 'RSA_OAEP', 
        ENCRYPTED_VALUE = 0x01A6000001680074007400700073003A002F002F00650066002D006B0076002D006400650076002D0031002E007600610075006C0074002E0061007A007500720065002E006E00650074002F006B006500790073002F00730071006C002D0063006D006B002D0031002F00340063003900300032006100620063006200630064006100340038006200320061006500650035003800300065003000620035006300350035006600320062000EF10DE0F16260F5DBA49973808D17036B07194E223C135BF6F73F845F6330B5379CE2EAC9A6ED5FB20736422D1841480976E1DA6FE5A3FF72707D8DA097FB896C102897B232BAC979A4BC938ECF5D425BED2196CA01F388AD0A3A2514553117B71AAD4B842E17D2C4A83D43702AF30AC9A7C3927BE256B1A4E2650DAB154391512F95E3652CDD45F6A9901BCCBBF3A38EC2E879A89133E26275D18FC3533EFBAB9219F42E86FD56E211A24825D06966F6E0937169909982CEC2E4AAEF64F46F12A8EA9C977C393537B343DAB02FB054680921515CA6B5B3763F7AC8D05DB9FA69B63014782E5715EBC7BCC7D241B1FB70E1F97AE39F95FCD41A15464A6D31A11ED6145040166A1250BD21DB3132966FA4EABEEFCE3976F0673D93243AB247079E33DA1A7E3194283142A9113597816BF30E196A92BF1677385D61AE2EFBA58E73CE8DE0CF6B7F1406B7E18D9A1239EE4480AB78337BFFCC72334F211077A753E1FFE76742D67733FB83BB168A4078EC854BCF43691BEAA06A1B31E5D6080260E77A48CAF04AF8BEDC3CB977DE8A5B91FCDB12014D400D09D138D88BD5E5A99765FA29256FC593A1E5A1A1B40140E339A73E1F516C0C2B02D126083259A610ADF3201BD84ADED01E355DFC26021AF02DEDA59CFEE1EF83059E202E91D6AF7EF7CCF55E880BCF23B5E63A92A3A401D07C80BCA69C246F474530B5C585138C5D5A
    );
    END
    ELSE
    BEGIN
        SELECT 'COLUMN ENCRYPTION KEY [CEK_WITH_AKV] exists.';
    END
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureDeterministic] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = DETERMINISTIC, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    ALTER TABLE [todo].[TodoItem]
                                    ALTER COLUMN [SecureRandom] varbinary(200) 
                                     ENCRYPTED WITH(
                                            ENCRYPTION_TYPE = RANDOMIZED, 
                                            ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', 
                                            COLUMN_ENCRYPTION_KEY = [CEK_WITH_AKV]) NULL
END;

IF NOT EXISTS (
    SELECT * FROM [__EFMigrationsHistory]
    WHERE [MigrationId] = N'20241202164906_InitialCreate'
)
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20241202164906_InitialCreate', N'9.0.0');
END;

COMMIT;
GO

